<dom-module id="timeoff-task-pending">

  <link rel="import" type="css" href="timeoff-task-pending.css">
  <link rel="import" href="../timeoff-behavior/timeoff-message.html">
  <link rel="import" href="../timeoff-behavior/timeoff-helper.html">

  <template>
    <style is="custom-style" include="shared-styles"></style>
    <nuxeo-resource id="nxoTaskPending" auto
                    path="task"
                    params="{{params}}"
                    response={{tasks}}></nuxeo-resource>
    <template is="dom-if" if="{{!isEmptyDataResponse(tasks)}}">
      <paper-material>
        <paper-header-panel>
          <paper-toolbar>
            <div>Pending Task Request</div>
          </paper-toolbar>
        </paper-header-panel>
        <div class="content">
          <template is="dom-repeat" items='[[tasks.entries]]' as="task" index-as="task-index">
            <div class="task flex">
              <timeoff-entry data=[[task]]>
                <div class="step">Step:[[getMessage(task.name)]]</div>
                <template is="dom-if" if="{{isCommentExist(task)}}">
                  <div style="display:inline-block">
                    <iron-icon alt="Comment" icon="help-outline"></iron-icon>
                    <paper-tooltip>[[getComment(task)]]</paper-tooltip>
                  </div>
                </template>
              </timeoff-entry>
              <div class="flex-end-justified">
                <template is="dom-if" if="{{isManagerHRTask(task)}}">
                  <button-accept-task task-id="[[task.id]]" on-accepted="refresh"></button-accept-task>
                  <button-request-update-task task-id="[[task.id]]" task-name="[[task.name]]"
                                              on-request-updated="refreshTasks"></button-request-update-task>
                  <button-reject-task task-id="[[task.id]]" task-name="[[task.name]]"
                                      on-rejected="refresh"></button-reject-task>
                </template>
                <template is="dom-if" if="{{!isManagerHRTask(task)}}">
                  <button-edit-task task="[[task]]" on-edited="refresh"></button-edit-task>
                </template>
              </div>
            </div>
          </template>
        </div>
      </paper-material>
    </template>
  </template>

</dom-module>
<script>
  (function() {
    Polymer({
      is: 'timeoff-task-pending',
      properties: {
        params: {
          type: Object,
          value: function() {
            return {'workflowModelName': 'TimeOffRequestFlow'};
          }
        }
      },
      behaviors: [TimeoffBehaviors.Message, TimeoffBehaviors.Helper],
      refreshTasks: function() {
        this.$.nxoTaskPending.execute();
      },
      refresh: function() {
        this.fire('refresh');
      },
      isManagerHRTask: function(task) {
        return task.name === 'tor.managerapproval.label' || task.name === 'tor.hrmanagerapproval.label';
      },
      isCommentExist: function(task) {
        return (task.name === 'tor.managerapproval.label' && !this._isStringEmpty(task.variables.commentRequester))
          || (task.name === 'tor.hrmanagerapproval.label' && !this._isStringEmpty(task.variables.commentRequester))
          || (task.name === 'tor.request_update.label' && !this._isStringEmpty(task.variables.commentManager) || !this._isStringEmpty(task.variables.commentHr))
      },
      getComment: function(task) {
        var result = '';
        if (task.name === 'tor.managerapproval.label') {
          result = 'Comment: ' + task.variables.commentRequester;
        } else if (task.name === 'tor.hrmanagerapproval.label') {
          result = 'Comment: ' + task.variables.commentRequester;
        } else if (task.name === 'tor.request_update.label') {
          if (!this._isStringEmpty(task.variables.commentManager)) {
            result = 'Comment manager: ' + task.variables.commentManager;
          } else if (!this._isStringEmpty(task.variables.commentHr)) {
            result = 'Comment HR: ' + task.variables.commentHr;
          }
        }
        return result;
      },
      _isStringEmpty: function(string) {
        return string == null || string === '';
      }
    });
  }());
</script>
