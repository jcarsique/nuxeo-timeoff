<dom-module id="timeoff-search">

  <template>
    <style is="custom-style" include="shared-styles"></style>
    <paper-material>
      <paper-header-panel>
        <paper-toolbar>
          <div>Incoming holidays</div>
          <div>H:[[nb.holiday]], R:[[nb.rtt]], F:[[nb.family]], U:[[nb.unpaid]]</div>
          <paper-icon-button id="menu" suffix icon="menu" on-click="_toggleCollapse"></paper-icon-button>
          <paper-tooltip for="menu">Configure</paper-tooltip>
        </paper-toolbar>
        <iron-collapse id="filtersPanel">
          <div class="content menu">
            <paper-input label="Begin date" readonly value$="[[filters.date.beginning]]">
              <paper-icon-button suffix icon="event" on-click="_openBeginDialog"></paper-icon-button>
              <paper-icon-button suffix icon="clear" on-click="_clearBegin"></paper-icon-button>
            </paper-input>
            <paper-input label="End date" readonly value$="[[filters.date.end]]">
              <paper-icon-button suffix icon="event" on-click="_openEndDialog"></paper-icon-button>
              <paper-icon-button suffix icon="clear" on-click="_clearEnd"></paper-icon-button>
            </paper-input>

            <template is="dom-if" if="[[isManager]]">
              <paper-input label="Other Employees" value="{{filters.employees}}">
                <paper-icon-button suffix icon="add" on-click="_openEmployeeDialog"></paper-icon-button>
              </paper-input>
            </template>
          </div>
        </iron-collapse>
      </paper-header-panel>

      <nuxeo-operation auto id="login" op="login" response="{{login}}"></nuxeo-operation>
      <nuxeo-operation id="userWorkspace" op="User.GetUserWorkspace"
        on-response="_userWorkspaceReceived"></nuxeo-operation>
      <nuxeo-operation id="incoming" op="Document.Query" response="{{data}}"></nuxeo-operation>
      <nuxeo-resource id="employees" path="directory/EmployeeManagerMapping"
        on-response="_employeeReceived"></nuxeo-resource>

      <div class="content">
        <template is="dom-if" if="[[!hasResult]]">
          <paper-card heading="No incoming holidays">
            <div class="card-content">
              :/
            </div>
          </paper-card>
        </template>

        <template is="dom-repeat" items='[[data.entries]]' as="item">
          <div class="request">
            <timeoff-entry data=[[item]]>
              <template is="dom-if" if="[[hasEmployeeFilter]]" restamp="true">
                [[item.properties.dc:creator]]
              </template>
            </timeoff-entry>
          </div>
        </template>
      </div>

      <!-- Begin date dialog -->
      <paper-dialog id="beginDatePicker" class="paper-date-picker-dialog" modal>
        <paper-date-picker date="{{filters.date.beginning}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
      <!-- End date dialog -->
      <paper-dialog id="endDatePicker" class="paper-date-picker-dialog" modal>
        <paper-date-picker date="{{filters.date.end}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
      <!-- Employee selection dialog -->
      <paper-dialog id="employeesSelection" modal>
        <h2>Select employees</h2>
        <paper-input label="Filter name" value="{{_filterEmployeesValue}}"></paper-input>
        <paper-dialog-scrollable>
          <paper-listbox multi on-iron-deselect="_employeesListChanged" on-iron-select="_employeesListChanged">
            <template is="dom-repeat" items='[[employees]]' as="item"
              filter="{{_filterEmployeesSelect(_filterEmployeesValue)}}">
              <paper-item value="[[item]]">[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-dismiss>Close</paper-button>
        </div>
      </paper-dialog>
    </paper-material>
  </template>

</dom-module>
<script>
  (function() {
    Polymer({
      is: 'timeoff-search',
      properties: {
        login: Object,
        userWorkspace: String,
        data: Object,
        _oldFilters: Object,
        hasResult: {
          type: Boolean,
          value: false
        },
        isManager: {
          type: Boolean,
          computed: "_isManager(employees)"
        },
        hasEmployeeFilter: {
          type: Boolean,
          computed: "_hasEmployeeFilter(data)"
        },
        filters: {
          type: Object,
          value: {
            date: {
              beginning: null,
              end: null
            },
            employees: ""
          },
          notify: true
        },
        nb: {
          type: Object,
          value: {}
        },
        employees: {
          type: Array,
          value: []
        }
      },
      observers: [
        "_updateUserContext(login)",
        "_refreshQuery(userWorkspace, filters.*)",
        "_calculateHolidays(data)"
      ],
      _userWorkspaceReceived: function(e) {
        this.set("userWorkspace", e.detail.response.path);
      },
      _employeesListChanged: function(e) {
        var value = e.detail.item.value.trim();
        if (!value) {
          return;
        }

        var splitString = function(str) {
          return str.split(/\s+/).filter(function(e) {
            return e; // Filter possible empty entries.
          });
        }.bind(this);

        switch (e.type) {
          case "iron-select":
            if (this.filters.employees.indexOf(value) >= 0) {
              break;
            }

            var employees = splitString(this.filters.employees);
            employees.push(value);
            this.set("filters.employees", employees.join(" "));
            break;
          case "iron-deselect":
            this.set("filters.employees", splitString(this.filters.employees.replace(value, '')).join(" "));
            break;
        }
      },
      refreshAll: function() {
        this.debounce('refreshAll', function() {
          this.$.incoming.execute();
        }.bind(this), 700);
      },
      _refreshQuery: function() {
        if (!this.login) {
          return;
        }
        if (JSON.stringify(this.filters) === this._oldFilters) {
          // Do not execute same query twice.
          return;
        }

        this.$.incoming.params = this._computeQuery();
        this.refreshAll();

        // Save current filters
        this.set("_oldFilters", JSON.stringify(this.filters));
      },
      _updateUserContext: function() {
        if (this.employees.length > 0) {
          return;
        }
        this.$.employees.execute();
        this.$.userWorkspace.execute();
      },
      _computeQuery: function() {
        var query = 'SELECT * FROM HRHolidayRequest where ';
        var filters = this.filters;

        if (filters.employees && filters.employees.length > 0) {
          var logins = "";
          // Manager wants to display someone else holidays
          filters.employees.trim().split(/\s+/).forEach(function(login) {
            // Strip non alphanumerics chars
            logins += '"' + login.replace(/[^a-zA-Z\d:_]/g, "") + '", ';
          });
          query += 'dc:creator IN (' + logins.substring(0, logins.length - 2) + ') ';
        } else {
          // Normal user request his holidays
          query += 'ecm:path startswith "' + this.userWorkspace + '" ';
        }

        if (!filters.date || !(filters.date.beginning || filters.date.end)) {
          filters.date = {
            beginning: new Date().setHours(0, 0, 0),
            end: null
          };
        }
        var beginning = moment(filters.date.beginning).toISOString();
        query += 'and (hrholidayrequest:beginning >= "' + beginning + '" ';
        query += 'or hrholidayrequest:end >= "' + beginning + '")';
        if (filters.date.end) {
          var end = moment(filters.date.end).toISOString();
          query += 'and hrholidayrequest:beginning < "' + end + '" ';
        }

        query += " order by hrholidayrequest:beginning";
        console.log(query);
        return {query: query};
      },
      _openBeginDialog: function() {
        this.$.beginDatePicker.open();
      },
      _openEndDialog: function() {
        this.$.endDatePicker.open();
      },
      _openEmployeeDialog: function() {
        this.$.employeesSelection.open();
      },
      _clearEnd: function() {
        this.filters.date.end = null;
        this.set("filters", this.filters);
        this.set("filters.date.end", null);
      },
      _clearBegin: function() {
        this.filters.date.beginning = null;
        this.set("filters", this.filters);
        this.set("filters.date.beginning", null);
      },
      _toggleCollapse: function() {
        this.$.filtersPanel.toggle();
      },
      _employeeReceived: function(e) {
        var employees = [];
        e.detail.response.entries.forEach(function(entry) {
          if (entry.properties.label === this.login.username) {
            employees.push(entry.properties.id);
          }
        }.bind(this));
        this.set('employees', employees.sort());
      },
      _isManager: function() {
        return this.employees && this.employees.length > 0;
      },
      _hasEmployeeFilter: function() {
        return this.filters.employees && this.filters.employees.length > 0;
      },
      _filterEmployeesSelect: function(e) {
        if (!e) {
          return null;
        }
        var str = e.toLowerCase();
        return function(value) {
          return value.toLowerCase().indexOf(str) != -1;
        };
      },
      _calculateHolidays: function() {
        var nb = {
          rtt: 0,
          holiday: 0,
          family: 0,
          unpaid: 0
        };

        this.set("hasResult", this.data && this.data.entries && this.data.entries.length > 0);
        if (this.hasResult) {
          this.data.entries.forEach(function(entry) {
            nb.family += parseInt(entry.properties['hrholidayrequest:numberFamilyCause']) || 0;
            nb.rtt += parseInt(entry.properties['hrholidayrequest:numberRTT']) || 0;
            nb.holiday += parseInt(entry.properties['hrholidayrequest:numberHoliday']) || 0;
            nb.unpaid += parseInt(entry.properties['hrholidayrequest:numberUnpaid']) || 0;
          });
        }

        this.set("nb", nb);
      }
    });
  }());
</script>
