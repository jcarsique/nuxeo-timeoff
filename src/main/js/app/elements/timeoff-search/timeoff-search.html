<dom-module id="timeoff-search">

  <template>
    <style is="custom-style" include="shared-styles"></style>
    <paper-material>
      <paper-header-panel>
        <paper-toolbar>
          <paper-tooltip for="menu">Configure</paper-tooltip>
          <div>Incoming holidays</div>
          <div>H:[[nb.holiday]], R:[[nb.rtt]], F:[[nb.family]], U:[[nb.unpaid]]</div>
            <paper-icon-button id="menu" suffix icon="menu" on-click="_toggleCollapse"></paper-icon-button>
        </paper-toolbar>
        <iron-collapse id="filtersPanel">
          <div>
            <paper-input label="Begin date" readonly value$="[[filters.date.begin]]">
              <paper-icon-button suffix icon="event" on-click="_openBeginDialog"></paper-icon-button>
              <paper-icon-button suffix icon="clear" on-click="_clearBegin"></paper-icon-button>
            </paper-input>
            <paper-input label="End date" readonly value$="[[filters.date.end]]">
              <paper-icon-button suffix icon="event" on-click="_openEndDialog"></paper-icon-button>
              <paper-icon-button suffix icon="clear" on-click="_clearEnd"></paper-icon-button>
            </paper-input>
          </div>
        </iron-collapse>
      </paper-header-panel>

      <nuxeo-operation auto id="login" op="login" response="{{login}}"></nuxeo-operation>
      <nuxeo-operation id="incoming" op="Document.Query" response="{{data}}"></nuxeo-operation>
      <nuxeo-resource id="employees" path="directory/EmployeeManagerMapping"
        on-response="_employeeReceived"></nuxeo-resource>

      <div class="content">
        <template is="dom-if" if="[[!hasResult]]">
          <paper-card heading="No incoming holidays">
            <div class="card-content">
              No incoming holidays... :/
            </div>
          </paper-card>
        </template>

        <template is="dom-repeat" items='[[data.entries]]' as="item">
          <div class="request">
            <timeoff-entry data=[[item]]></timeoff-entry>
          </div>
        </template>
      </div>

      <paper-dialog id="beginDatePicker" class="paper-date-picker-dialog" modal>
        <paper-date-picker date="{{filters.date.begin}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog id="endDatePicker" class="paper-date-picker-dialog" modal>
        <paper-date-picker date="{{filters.date.end}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
    </paper-material>
  </template>

</dom-module>
<script>
  (function() {
    Polymer({
      is: 'timeoff-search',
      properties: {
        login: Object,
        data: Object,
        _oldFilters: Object,
        hasResult: {
          type: Boolean,
          value: false
        },
        filters: {
          type: Object,
          value: {
            date: {}
          },
          notify: true
        },
        nb: {
          type: Object,
          value: {}
        },
        employees: {
          type: Array,
          value: []
        }
      },
      observers: [
        "_refreshQuery(login, filters.*)",
        "_updateEmployees(login)",
        "_calculateHolidays(data)"
      ],
      _refreshQuery: function() {
        if (!this.login) {
          return;
        }
        if (JSON.stringify(this.filters) === this._oldFilters) {
          // Do not execute same query twice.
          return;
        }

        this.$.incoming.params = this._computeQuery();
        this.$.incoming.execute();

        // Save current filters
        this.set("_oldFilters", JSON.stringify(this.filters));
      },
      _updateEmployees: function() {
        if (this.employees.length > 0) {
          return;
        }
        this.$.employees.execute();
      },
      _computeQuery: function() {
        var query = 'SELECT * FROM HRHolidayRequest ' +
          'where ecm:path startswith "/default-domain/UserWorkspaces/' + this.login.username + '" ';
        var filters = this.filters;
        if (!filters.date || !(filters.date.begin || filters.date.end)) {
          filters.date = {
            begin: new Date().setHours(0, 0, 0),
            end: null
          };
        }
        var begin = moment(filters.date.begin).toISOString();
        query += 'and (hrholidayrequest:beginning >= "' + begin + '" ';
        query += 'or hrholidayrequest:end >= "' + begin + '")';
        if (filters.date.end) {
          var end = moment(filters.date.end).toISOString();
          query += 'and hrholidayrequest:beginning < "' + end + '" ';
        }

        query += " order by hrholidayrequest:beginning";
        console.log(query);
        return {query: query};
      },
      _openBeginDialog: function() {
        this.$.beginDatePicker.open();
      },
      _openEndDialog: function() {
        this.$.endDatePicker.open();
      },
      _clearEnd: function() {
        this.filters.date.end = null;
        this.set("filters", this.filters);
        this.set("filters.date.end", null);
      },
      _clearBegin: function() {
        this.filters.date.begin = null;
        this.set("filters", this.filters);
        this.set("filters.date.begin", null);
      },
      _toggleCollapse: function() {
        this.$.filtersPanel.toggle();
      },
      _employeeReceived: function(e) {
        var employees = [];
        e.detail.response.entries.forEach(function(entry) {
          if (entry.properties.label === this.login.username) {
            employees.push(entry.properties.id);
          }
        }.bind(this));
        this.set('employees', employees.sort());
      },
      _calculateHolidays: function() {
        var nb = {
          rtt: 0,
          holiday: 0,
          family: 0,
          unpaid: 0
        };

        this.set("hasResult", this.data && this.data.entries && this.data.entries.length > 0);
        if (this.hasResult) {
          this.data.entries.forEach(function(entry) {
            nb.family += parseInt(entry.properties['hrholidayrequest:numberFamilyCause']) || 0;
            nb.rtt += parseInt(entry.properties['hrholidayrequest:numberRTT']) || 0;
            nb.holiday += parseInt(entry.properties['hrholidayrequest:numberHoliday']) || 0;
            nb.unpaid += parseInt(entry.properties['hrholidayrequest:numberUnpaid']) || 0;
          });
        }

        this.set("nb", nb);
      }
    });
  }());
</script>
