<!--
  ~ (C) Copyright 2006-2016 Nuxeo SA (http://nuxeo.com/) and contributors.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  ~
  ~  Contributors:
  ~     nuxeo
  -->

<dom-module id="timeoff-creation">

  <link rel="import" type="css" href="timeoff-creation.css">
  <script src="../../bower_components/es6-promise/promise.min.js"></script>

  <template>
    <style is="custom-style" include="shared-styles"></style>
    <nuxeo-resource id="nxr" path="workflow" method="post" data="{{data}}"></nuxeo-resource>
    <paper-icon-button id="btn" icon="add" raised on-click="openDialog" alt="New request"></paper-icon-button>
    <paper-tooltip for="btn" position="top">New request</paper-tooltip>

    <dialog-request-creation id="dialog" data="{{data}}" on-submit="_submit"></dialog-request-creation>

  </template>
  <script>
    (function() {
      Polymer({
        is: 'timeoff-creation',
        properties: {
          data: Object,
        },

        ready: function() {
          this._reset();
        },
        openDialog: function() {
          this.$.dialog.open();
        },
        _submit: function() {
          this.$.nxr.post().then(function() {
            app.$.toast.text = 'Your request has been created.';
            app.$.toast.show();

            this._reset();
            this.fire('create-request');
          }.bind(this));
        },
        _reset: function() {
          this.data = {
            'variables': {
              'beginning': moment().toDate(),
              'end': moment().toDate(),
              'numberHoliday': null,
              'numberRTT': null,
              'numberFamilyCause': null,
              'numberUnpaid': null,
              'commentRequester': ''
            },
            'workflowModelName': 'TimeOffRequestFlow'
          };
        },
        editRequest: function() {
          // Edit is delete then create.
          var that = this;
          this.$.delete.execute().then(function() {
            that.createRequest();
          });
        }
      });
    }());
  </script>
</dom-module>
