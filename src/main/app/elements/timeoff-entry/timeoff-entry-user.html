<!--
  ~ (C) Copyright 2006-2016 Nuxeo SA (http://nuxeo.com/) and contributors.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  ~
  ~  Contributors:
  ~     nuxeo
  -->
<link rel="import" href="../timeoff-behavior/timeoff-entry-helper.html">

<dom-module id="timeoff-entry-user">
  <template>
    <nuxeo-resource id="nxr" path="user/[[username]]" method="get"></nuxeo-resource>
    <timeoff-entry data="{{data}}">
      <content select="[prefix]"></content>
      <div prefix class="requester" hidden$="[[userHidden]]">
        <iron-icon icon="account-circle"></iron-icon>[[user]]
      </div>
      <content select="[suffix]"></content>
    </timeoff-entry>
  </template>
</dom-module>
<script>
// A map of username information with following format:
// {
//   '$username': {
//     'name': '$name',
//     'date': '$date'
//   },
//   '$username': {
//     'loading': boolean
//   },
//   ...
// }
var names = {};
// A map of elements which subscribe to callback of resource request:
// {
//   '$username': [ 'element1', 'element2', ...],
//   ...
// }
var elements = {};
(function() {
  Polymer({
    is: 'timeoff-entry-user',
    behaviors: [TimeoffBehaviors.EntryHelper],
    properties: {
      data: {
        type: Object,
        value: null
      },
      username: {
        type: String,
        computed: '_readUsername(data)',
        observer: '_retrieveUser'
      },
      user: {
        type: String
      },
      userHidden: {
        type: Boolean,
        value: false
      }
    },
    _readUsername: function(entry) {
      var key;
      switch (entry['entity-type']) {
        case 'document':
          key = 'creator';
          break;
        case 'task':
        case 'workflow':
          key = 'requester';
          break;
        default:
          console.log('[timeoff-entry-user] Unknown entity-type ' + entry['entity-type']);
      }
      return this.readProperty(key);
    },
    _readUser: function() {
      if (names[this.username]) {
        this.user = names[this.username].name;
      } else {
        this.user = 'NC';
      }
    },
    _retrieveUser: function() {
      var name = names[this.username];
      var needLoad = !name || typeof name.date === 'undefined' || moment(name.date).add(1, 'week').isBefore(moment());
      var loading = typeof name !== 'undefined' && name.loading;
      if (needLoad) {
        elements[this.username] = elements[this.username] || [];
        elements[this.username].push(this);
        if (!loading) {
          // First put an object to do only one request by this.username
          names[this.username] = {loading: true};
          // Second retrieve value
          this.$.nxr.execute().then(function(response) {
            name = {};
            var properties = response.properties;
            if (properties && (properties.firstName !== '' || properties.lastName !== '')) {
              name.name = properties.firstName + ' ' + properties.lastName;
            } else {
              name.name = this.username;
            }
            name.date = moment().toDate();
            names[this.username] = name;

            elements[this.username].forEach(function(element) {
              element._readUser();
            });
            elements[this.username] = [];
          }.bind(this));
        }
      } else {
        this._readUser();
      }
    }
  });
}());
</script>
